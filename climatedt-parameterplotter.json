{"version":2,"kind":"Notebook","sha256":"6fc9d961416f172049017996bb8f2623322852c535e9002e7c01d45de6b9b15d","slug":"climatedt-parameterplotter","location":"/HDA/DestinE_Digital_Twins/ClimateDT-ParameterPlotter.ipynb","dependencies":[],"frontmatter":{"title":"DEDL - HDA Climate DT Parameter Plotter - Tutorial","content_includes_title":true,"kernelspec":{"name":"python_dedl","display_name":"Python DEDL","language":"python"},"numbering":{"title":{"offset":2}},"thumbnail":"/build/b27bd30f978ddf0848f3ea0942070886.jpeg","exports":[{"format":"ipynb","filename":"ClimateDT-ParameterPlotter.ipynb","url":"/build/ClimateDT-ParameterP-08cb391f169d80fc3b24fc8e3665ccf9.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"image","url":"/build/b27bd30f978ddf0848f3ea0942070886.jpeg","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EHD8i25CFo","urlSource":"https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/img/DestinE-banner.jpg?raw=true"}],"visibility":"show","key":"EHJAUWvmgS"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"DEDL - HDA Climate DT Parameter Plotter - Tutorial","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KjfnbsT07v"}],"identifier":"dedl-hda-climate-dt-parameter-plotter-tutorial","label":"DEDL - HDA Climate DT Parameter Plotter - Tutorial","html_id":"dedl-hda-climate-dt-parameter-plotter-tutorial","implicit":true,"key":"cu4BrHbZkf"}],"key":"D4iuhUlrWf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Author","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UoZa5ovZa3"}],"key":"zhtPdiC4M9"},{"type":"text","value":": EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VijbgmSGNo"},{"type":"break","key":"LXu1Tw5lPi"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"COU9fw5TO2"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Copyright","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"muZxGRHVjM"}],"key":"qVjKIArbsS"},{"type":"text","value":": 2024 EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jOn1GyT4Ws"},{"type":"break","key":"zpBo9V05Q0"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xorNeehlJF"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Licence","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sfvocHO7Bg"}],"key":"BHxzR57mkD"},{"type":"text","value":": MIT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"quDYWCfxnc"},{"type":"break","key":"ZjyZS1iMli"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UWMTQvNtSk"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Credit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"e3yQ8OpynI"}],"key":"gBvHYZ6hyb"},{"type":"text","value":": Earthkit and HDA Polytope used in this context are both packages provided by the European Centre for Medium-Range Weather Forecasts (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xP1JogcyVR"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"ECMWF","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GhHzd64zCX"}],"key":"tAsoflWbLS"},{"type":"text","value":").","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XZd4NhdOJl"}],"key":"uQ3cvY8uo0"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"DEDL Harmonised Data Access","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"t0Mmh3uLcv"}],"key":"skmfOLg6GF"},{"type":"text","value":" is used in this example to access and plot Climate DT parameter.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"MRgUMcNLOV"}],"key":"fLzLZEhMRF"}],"key":"ra3yBn1e5F"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"link","url":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-discovery-and-data-access/Introduction-to-Discovery-and-Data-Access-services/Introduction-to-Discovery-and-Data-Access-services.html#hda-harmonised-data-access","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Documentation DestinE DataLake HDA","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"cRRYo63AHH"}],"urlSource":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-discovery-and-data-access/Introduction-to-Discovery-and-Data-Access-services/Introduction-to-Discovery-and-Data-Access-services.html#hda-harmonised-data-access","key":"OoAjCdinnK"}],"key":"fEw58DnP0U"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"link","url":"https://confluence.ecmwf.int/display/DDCZ/DestinE+Parameter+Portfolios","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Documentation Digital Twin - Parameter Usage","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"DkgMkF9gCg"}],"urlSource":"https://confluence.ecmwf.int/display/DDCZ/DestinE+Parameter+Portfolios","key":"PvhGT67O98"}],"key":"viTxVOoOEt"}],"visibility":"show","key":"xceEWjVIzK"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import the required packages","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LtfEms1Xid"}],"identifier":"import-the-required-packages","label":"Import the required packages","html_id":"import-the-required-packages","implicit":true,"key":"yEfYmabc0r"}],"key":"ZObtmg9FMA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Import the Climate DT parameter & scenario dictionary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h6bQ6kKeeW"}],"key":"R1f94PF2d4"}],"key":"iQ1dEdwXLN"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from destinelab import climate_dt_dictionary\nimport ipywidgets as widgets\nimport json\nimport datetime\n\nimport importlib.metadata","visibility":"show","key":"JKI29Kezfe"},{"type":"output","id":"rV1Xc4Lt3qqrYroYFAIHR","data":[],"visibility":"show","key":"B6MV2M3FbD"}],"visibility":"show","key":"NVJoAcTsLI"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Climate DT parameter selection (we limit the plotting to one parameter)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NNElJXq1En"}],"identifier":"climate-dt-parameter-selection-we-limit-the-plotting-to-one-parameter","label":"Climate DT parameter selection (we limit the plotting to one parameter)","html_id":"climate-dt-parameter-selection-we-limit-the-plotting-to-one-parameter","implicit":true,"key":"HDVybsB8qc"}],"key":"jSfkqQUCSj"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Create search box\nsearch_box = widgets.Text(placeholder='Search by parameter name', description='Search:', disabled=False)\n\n# Create dropdown to select entry\nentry_dropdown = widgets.Dropdown(\n    options=[(entry['paramName'], i) for i, entry in enumerate(climate_dt_dictionary.climateDT_params)],\n    description='Select Entry:'\n)\n\ndef filter_entries(search_string):\n    return [(entry['paramName'], i) for i, entry in enumerate(climate_dt_dictionary.climateDT_params) if search_string.lower() in entry['paramName'].lower()]\n\ndef on_search_change(change):\n    search_string = change.new\n    if search_string:\n        filtered_options = filter_entries(search_string)\n        entry_dropdown.options = filtered_options\n    else:\n        entry_dropdown.options = [(entry['paramName'], i) for i, entry in enumerate(climate_dt_dictionary.climateDT_params)]\n\nsearch_box.observe(on_search_change, names='value')\n\n# Display widgets\ndisplay(search_box, entry_dropdown)\n\ndef get_selected_entry():\n    return entry_dropdown.value\n","visibility":"show","key":"pGDuSFBos3"},{"type":"output","id":"n1yXKSxRjLJxPd0LB7uJX","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"730e94738cca4f2580fa8dcec2a61bee\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Text(value='', description='Search:', placeholder='Search by parameter name')","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"82c5302bd69343d3b3c20ca9f07ccb82\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Dropdown(description='Select Entry:', options=(('Total column cloud liquid water', 0), ('Total column cloud ic…","content_type":"text/plain"}}}],"visibility":"show","key":"FAibTzhB98"}],"visibility":"show","key":"V5tDLvIebw"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Print the details of the parameter (Polytope convention):\nselected_index = get_selected_entry()\nselected_entry = climate_dt_dictionary.climateDT_params[selected_index]\nprint(json.dumps(selected_entry,indent=4))","visibility":"show","key":"g85e3JVvKN"},{"type":"output","id":"zeDPAG3pYOKDDRHnLgZsx","data":[{"name":"stdout","output_type":"stream","text":"{\n    \"param\": \"167\",\n    \"paramName\": \"2 metre temperature\",\n    \"shortName\": \"2t\",\n    \"unit\": \"K\",\n    \"encoding\": \"instantaneous\",\n    \"isNemo\": \"IFS-NEMO\",\n    \"isIcon\": \"ICON\",\n    \"isFESOM\": \"IFS-FESOM\",\n    \"stream\": \"clte\",\n    \"type\": \"fc\",\n    \"time\": \"Hourly\",\n    \"levtype\": \"sfc\",\n    \"levelist\": \"\"\n}\n"}],"visibility":"show","key":"E4r7GCKRn2"}],"visibility":"show","key":"SJ9HupjKQs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Choose now the Scenario from which we want to obtain the Climate Parameter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"o17QtDBWmh"}],"identifier":"choose-now-the-scenario-from-which-we-want-to-obtain-the-climate-parameter","label":"Choose now the Scenario from which we want to obtain the Climate Parameter","html_id":"choose-now-the-scenario-from-which-we-want-to-obtain-the-climate-parameter","implicit":true,"key":"JqvuECnwns"}],"key":"YJwucHkCPD"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Create dropdown to select scenario\nscenario_dropdown = widgets.Dropdown(\n    options=[(f\"{entry['experiment']} - {entry['model']} - {resolution}\", (i, resolution)) for i, entry in enumerate(climate_dt_dictionary.climateDT_scenario) for resolution in entry['resolution']],\n    description='Scenario:'\n)\n\n# Function to generate hourly slots\ndef generate_hourly_slots():\n    hours = []\n    for hour in range(0, 24):\n        for minute in range(0, 60, 60):  # Step by 60 minutes (1 hour)\n            hours.append(datetime.time(hour, minute))\n    return hours\n\n# Create dropdown to select hour\nhourly_slots = generate_hourly_slots()\nhour_dropdown = widgets.Dropdown(options=[(str(slot), slot) for slot in hourly_slots], description='Select Hour:', disabled=False)\n\n# Create date picker widgets\nstart_date_picker = widgets.DatePicker(description='Start Date:', disabled=False)\n\ndef on_scenario_change(change):\n    selected_index, selected_resolution = change.new\n    selected_sc_entry = climate_dt_dictionary.climateDT_scenario[selected_index]\n    date_from = datetime.datetime.strptime(selected_sc_entry['dateFrom'], '%m/%d/%Y').date()\n    start_date_picker.max = None\n    start_date_picker.min = date_from\n    start_date_picker.max = datetime.datetime.strptime(selected_sc_entry['dateTo'], '%m/%d/%Y').date()\n    start_date_picker.value = date_from\n\nscenario_dropdown.observe(on_scenario_change, names='value')\n\n# Set initial values directly\nselected_sc_entry = climate_dt_dictionary.climateDT_scenario[0]\n# Convert dateFrom string to date object\ndate_from = datetime.datetime.strptime(selected_sc_entry['dateFrom'], '%m/%d/%Y').date()\n\n# Set initial values directly\nstart_date_picker.min = date_from\nstart_date_picker.max = datetime.datetime.strptime(selected_sc_entry['dateTo'], '%m/%d/%Y').date()\nstart_date_picker.value = date_from\n\n# Display widgets\nif selected_entry[\"time\"] == \"Hourly\":\n    display(scenario_dropdown, start_date_picker, hour_dropdown)\nelse:\n    display(scenario_dropdown, start_date_picker)\n\ndef get_selected_values():\n    selected_scenario_index, selected_resolution = scenario_dropdown.value\n    selected_scenario = climate_dt_dictionary.climateDT_scenario[selected_scenario_index]\n    selected_start_date = start_date_picker.value\n    selected_end_date = \"\" # end_date_picker.value\n    selected_hour = \"00:00:00\"\n    if selected_entry[\"time\"] == \"Hourly\":\n        selected_hour = hour_dropdown.value\n        \n    return selected_scenario_index, selected_scenario, selected_resolution, selected_start_date, selected_end_date, selected_hour\n\n# Example usage:\nselected_scenario_index, selected_scenario, selected_resolution, selected_start_date, selected_end_date, selected_hour = get_selected_values()\n","visibility":"show","key":"UDfor0apCe"},{"type":"output","id":"76Q0vWIa1xTxJjNoLWoNd","data":[{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"d203ab7602144686be6f7b0568502bcf\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Dropdown(description='Scenario:', options=(('ssp3-7.0 - IFS-NEMO - high', (0, 'high')), ('ssp3-7.0 - IFS-NEMO …","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"e6568786ead64ebb9c292c6c713eeeeb\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"DatePicker(value=datetime.date(2020, 1, 1), description='Start Date:', max=datetime.date(2039, 12, 30), min=da…","content_type":"text/plain"}}},{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"bc39b8ce57e244818b2bf3f38cc5472b\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"text/plain":{"content":"Dropdown(description='Select Hour:', options=(('00:00:00', datetime.time(0, 0)), ('01:00:00', datetime.time(1,…","content_type":"text/plain"}}}],"visibility":"show","key":"NuXRpv8EKe"}],"visibility":"show","key":"ZbbdEQTLZX"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Handle different Levels to be selected (if any)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iJMYo8na3c"}],"key":"EOoN1ddcqT"}],"key":"Iw8OhNat8g"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Define a global variable\nglobal global_widget\nglobal_widget = None\n\nif selected_entry[\"levelist\"] != \"\":\n    # Convert levelist string to list of integers\n    levelist = list(map(int, selected_entry[\"levelist\"].split('/')))\n    if(selected_scenario['model']=='IFS-NEMO'):\n        levelist = levelist + [73,74,75]\n\n      \n    # Create a function to generate the widget based on the selection mode\n    def generate_widget(selection_mode):\n        global global_widget\n        if selection_mode == 'Single':\n            global_widget = widgets.Dropdown(options=levelist, description='Select level:')\n            return global_widget\n        elif selection_mode == 'Multiple':\n            global_widget = widgets.SelectMultiple(options=levelist, description='Select levels:')\n            return global_widget\n\n    # Create a dropdown widget to choose selection mode\n    selection_mode_dropdown = widgets.Dropdown(options=['Single', 'Multiple'], description='Selection Mode:')\n\n    # Create an output widget to display the selected option(s)\n    output = widgets.Output()\n\n    # Function to display the widget based on the selection mode\n    def display_widget(selection_mode):\n        output.clear_output()\n        with output:\n            display(generate_widget(selection_mode))\n\n    # Define a function to handle the change in selection mode\n    def on_dropdown_change(change):\n        display_widget(change.new)\n\n    # Register the function to handle dropdown changes\n    selection_mode_dropdown.observe(on_dropdown_change, names='value')\n\n    # Display the widgets\n    display(selection_mode_dropdown, output)\n\n    # Display the initial widget based on default selection mode\n    display_widget('Single')","visibility":"show","key":"MV0sXyjYcj"},{"type":"output","id":"EyGmKCJGtAqIoYb4-TWhj","data":[],"visibility":"show","key":"IaON9vK7r2"}],"visibility":"show","key":"tITGnnjdQ9"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Function to convert tuple or single integer to string separated by \"/\"\ndef convert_to_string(input):\n    if isinstance(input, tuple):\n        return '/'.join(map(str, input))\n    elif isinstance(input, int):\n        return str(input)\n    else:\n        return None  # Handle other types if needed\n\nlevlInput = \"\"\nif global_widget != None:\n    # Test cases\n    levlInput = convert_to_string(global_widget.value)\n","visibility":"show","key":"SvLrd4yBEA"},{"type":"output","id":"torvuGNJEN5hKUFtwgH9S","data":[],"visibility":"show","key":"ICd2jugNGh"}],"visibility":"show","key":"G6myYsHQyf"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"hourchoice4 = '{shour}00'.format(shour = str(get_selected_values()[5]).split(\":\")[0])\n\nfilter_params = {\n  \"class\": \"d1\",             # fixed \n  \"dataset\": \"climate-dt\",   # fixed climate-dt access\n  \"activity\" : get_selected_values()[1][\"activity\"],\n  \"experiment\" : get_selected_values()[1][\"experiment\"].upper(),\n  \"model\": get_selected_values()[1][\"model\"],\n  \"generation\": \"1\",         # fixed Specifies the generation of the dataset, which can be incremented as required (latest is 1)\n  \"realization\": \"1\",        # fixed Specifies the climate realization. Default 1. Based on perturbations of initial conditions\n  \"resolution\": get_selected_values()[2],      # standard/ high \n  \"expver\": \"0001\",          # fixed experiment version \n  \"stream\": selected_entry[\"stream\"],\n  \"time\": hourchoice4,            # choose the hourly slot(s)\n  \"type\": \"fc\",              # fixed forecasted fields\n  \"levtype\": selected_entry[\"levtype\"],  \n  \"levelist\": str(levlInput),  \n  \"param\": str(selected_entry[\"param\"]),  \n}\n\n# Print the result in JSON format\ndatechoice = \"{fname}T{shour}Z\".format(fname = get_selected_values()[3], shour = get_selected_values()[5] )\nprint(\"datechoice = \", datechoice)\nprint(json.dumps(filter_params, indent=4))\n","visibility":"show","key":"aVRqJEUvAp"},{"type":"output","id":"0BaNL7caeMhXPE2U5No-E","data":[{"name":"stdout","output_type":"stream","text":"datechoice =  2028-06-06T00:00:00Z\n{\n    \"class\": \"d1\",\n    \"dataset\": \"climate-dt\",\n    \"activity\": \"ScenarioMIP\",\n    \"experiment\": \"SSP3-7.0\",\n    \"model\": \"IFS-NEMO\",\n    \"generation\": \"1\",\n    \"realization\": \"1\",\n    \"resolution\": \"high\",\n    \"expver\": \"0001\",\n    \"stream\": \"clte\",\n    \"time\": \"0000\",\n    \"type\": \"fc\",\n    \"levtype\": \"sfc\",\n    \"levelist\": \"\",\n    \"param\": \"167\"\n}\n"}],"visibility":"show","key":"Vdqy5t4gF3"}],"visibility":"show","key":"GvGcppEiju"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Obtain Authentication Token","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H8A8zQz4hl"}],"identifier":"obtain-authentication-token","label":"Obtain Authentication Token","html_id":"obtain-authentication-token","implicit":true,"key":"SRiUPQ2EjC"}],"key":"rjCX3pWY1v"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import requests\nfrom requests.adapters import HTTPAdapter\nfrom urllib3.util.retry import Retry\nimport json\nimport os\nfrom getpass import getpass\nimport destinelab as deauth","visibility":"show","key":"Lm2fH56lxz"},{"type":"output","id":"ohVVKdQWBOoxxPiadfOeI","data":[],"visibility":"show","key":"fzbECmPn4K"}],"visibility":"show","key":"MfWl49K5Lv"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"DESP_USERNAME = input(\"Please input your DESP username: \")\nDESP_PASSWORD = getpass(\"Please input your DESP password: \")\n\nauth = deauth.AuthHandler(DESP_USERNAME, DESP_PASSWORD)\naccess_token = auth.get_token()\nif access_token is not None:\n    print(\"DEDL/DESP Access Token Obtained Successfully\")\nelse:\n    print(\"Failed to Obtain DEDL/DESP Access Token\")\n\nauth_headers = {\"Authorization\": f\"Bearer {access_token}\"}","visibility":"show","key":"gVM7FQ47Cx"},{"type":"output","id":"sD44rAZrXa2eQczelsSbu","data":[{"name":"stdin","output_type":"stream","text":"Please input your DESP username:  eum-dedl-user\nPlease input your DESP password:  ········\n"},{"name":"stdout","output_type":"stream","text":"Response code: 200\nDEDL/DESP Access Token Obtained Successfully\n"}],"visibility":"show","key":"Q0JTz1M030"}],"visibility":"show","key":"CdbDBrcz4H"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Check if DT access is granted","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iY1oO3NaCq"}],"identifier":"check-if-dt-access-is-granted","label":"Check if DT access is granted","html_id":"check-if-dt-access-is-granted","implicit":true,"key":"t5hImY1Y7N"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If DT access is not granted, you will not be able to execute the rest of the notebook.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"OBT3R9NcPW"}],"key":"LRrJKCdNTr"}],"key":"COkLG29tK1"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import importlib\ninstalled_version = importlib.metadata.version(\"destinelab\")\nversion_number = installed_version.split('.')[1]\nif((int(version_number) >= 8 and float(installed_version) < 1) or float(installed_version) >= 1):\n    auth.is_DTaccess_allowed(access_token)","visibility":"show","key":"UAKglMOcG6"},{"type":"output","id":"g2Y6AsXrC5B54yq9R4RcM","data":[{"name":"stdout","output_type":"stream","text":"DT Output access allowed\n"}],"visibility":"show","key":"IWAEhszTBy"}],"visibility":"show","key":"dxs9uKFRmx"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Query using the DEDL HDA API","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Dpr45aB0BF"}],"identifier":"query-using-the-dedl-hda-api","label":"Query using the DEDL HDA API","html_id":"query-using-the-dedl-hda-api","implicit":true,"key":"cxzYUtRCfu"}],"key":"gV4vpsn5pP"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hBq3iOgfgW"}],"identifier":"filter","label":"Filter","html_id":"filter","implicit":true,"key":"Cy6zbWBhyD"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We have to setup up a filter and define which data to obtain.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"v8uCafSj2B"}],"key":"NKmH0bWsl9"}],"key":"ny8JEyVoKL"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Check if levelist is empty and remove it\nif filter_params.get(\"levelist\") == \"\":\n    del filter_params[\"levelist\"]\n\nif selected_entry[\"time\"] == \"Daily\":\n    del filter_params[\"time\"]\n\n    \nhdaFilters = {\n    key: {\"eq\": value}\n    for key, value in filter_params.items()\n}\n\n#print(hdaFilters)","visibility":"show","key":"BLnsfAx6lt"},{"type":"output","id":"Gd3bYufb1gOcLvZyg_A4b","data":[],"visibility":"show","key":"BuGZLr8byl"}],"visibility":"show","key":"Cdv843Sx4Y"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make Data Request","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NIkm1aEtrI"}],"identifier":"make-data-request","label":"Make Data Request","html_id":"make-data-request","implicit":true,"key":"NstrM1pC1O"}],"visibility":"show","key":"ihl1WmYGDs"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"#Sometimes requests to polytope get timeouts, it is then convenient define a retry strategy\nretry_strategy = Retry(\n    total=5,  # Total number of retries\n    status_forcelist=[500, 502, 503, 504],  # List of 5xx status codes to retry on\n    allowed_methods=[\"GET\",'POST'],  # Methods to retry\n    backoff_factor=1  # Wait time between retries (exponential backoff)\n)\n\n# Create an adapter with the retry strategy\nadapter = HTTPAdapter(max_retries=retry_strategy)\n\n# Create a session and mount the adapter\nsession = requests.Session()\nsession.mount(\"https://\", adapter)\n\nresponse = session.post(\"https://hda.data.destination-earth.eu/stac/search\", headers=auth_headers, json={\n \"collections\": [\"EO.ECMWF.DAT.DT_CLIMATE_ADAPTATION\"],\n    \"datetime\": datechoice,\n    \"query\": hdaFilters\n})\n\nif(response.status_code!= 200):\n    (print(response.text))\nresponse.raise_for_status()\n# Requests to EO.ECMWF.DAT.DT_CLIMATE always return a single item containing all the requested data\nproduct = response.json()[\"features\"][0]\nproduct[\"id\"]","visibility":"show","key":"jasz9qtcQB"},{"type":"output","id":"oAecXmaU-KA8lxDLcv3nZ","data":[{"output_type":"execute_result","execution_count":20,"metadata":{},"data":{"text/plain":{"content":"'DT_CLIMATE_ADAPTATION_20280606_20280606_7d019c7832c598efe2ebdc08e5f6ec54e553b5d7'","content_type":"text/plain"}}}],"visibility":"show","key":"lIZyGJuaY5"}],"visibility":"show","key":"IVWJT4zyfn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Submission worked ? Once our product found, we download the data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZjT17SsSS5"}],"identifier":"submission-worked-once-our-product-found-we-download-the-data","label":"Submission worked ? Once our product found, we download the data.","html_id":"submission-worked-once-our-product-found-we-download-the-data","implicit":true,"key":"cBclzMzpvG"}],"key":"i3W1ZqZBu5"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import JSON\n\n# DownloadLink is an asset representing the whole product\ndownload_url = product[\"assets\"][\"downloadLink\"][\"href\"]\nHTTP_SUCCESS_CODE = 200\nHTTP_ACCEPTED_CODE = 202\n\ndirect_download_url=''\n\nresponse = session.get(download_url, headers=auth_headers)\nif (response.status_code == HTTP_SUCCESS_CODE):\n    direct_download_url = product['assets']['downloadLink']['href']\nelif (response.status_code != HTTP_ACCEPTED_CODE):\n    print(response.text)\nprint(download_url)\nresponse.raise_for_status()\n    ","visibility":"show","key":"shFS3asXub"},{"type":"output","id":"Ck3RkjshwmF7DurfJJ2za","data":[{"name":"stdout","output_type":"stream","text":"https://hda.data.destination-earth.eu/stac/collections/EO.ECMWF.DAT.DT_CLIMATE_ADAPTATION/items/DT_CLIMATE_ADAPTATION_20280606_20280606_7d019c7832c598efe2ebdc08e5f6ec54e553b5d7/download?provider=dedt_lumi&_dc_qs=%257B%2522activity%2522%253A%2B%2522ScenarioMIP%2522%252C%2B%2522class%2522%253A%2B%2522d1%2522%252C%2B%2522dataset%2522%253A%2B%2522climate-dt%2522%252C%2B%2522date%2522%253A%2B%252220280606%252Fto%252F20280606%2522%252C%2B%2522experiment%2522%253A%2B%2522SSP3-7.0%2522%252C%2B%2522expver%2522%253A%2B%25220001%2522%252C%2B%2522generation%2522%253A%2B%25221%2522%252C%2B%2522levtype%2522%253A%2B%2522sfc%2522%252C%2B%2522model%2522%253A%2B%2522IFS-NEMO%2522%252C%2B%2522param%2522%253A%2B%2522167%2522%252C%2B%2522realization%2522%253A%2B%25221%2522%252C%2B%2522resolution%2522%253A%2B%2522high%2522%252C%2B%2522stream%2522%253A%2B%2522clte%2522%252C%2B%2522time%2522%253A%2B%25220000%2522%252C%2B%2522type%2522%253A%2B%2522fc%2522%257D\n"}],"visibility":"show","key":"GzNMiCRGni"}],"visibility":"show","key":"h9noXz2Uve"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Wait until data is there","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UurZm3H2yF"}],"identifier":"wait-until-data-is-there","label":"Wait until data is there","html_id":"wait-until-data-is-there","implicit":true,"key":"lQIUezDgwI"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This data is not available at the moment. And we can see that our request is in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EJTrM301Ei"},{"type":"inlineCode","value":"queued","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BcJZbnQ3cY"},{"type":"text","value":"status.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xo6YWp5ct3"},{"type":"break","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QFHaSszXjn"},{"type":"text","value":"We will now poll the API until the data is ready and then download it.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oVZpQverQa"}],"key":"i9QLUIXbES"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Please note that the basic HDA quota allows a maximum of 4 requests per second. The following code limits polling to this quota.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"auPTh19Ru5"}],"key":"lWRxotcH5h"}],"key":"H0HMtSuIi8"}],"key":"jHXinojFgq"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"pip install --user ratelimit --quiet","visibility":"show","key":"DalVGJCEPB"},{"type":"output","id":"OL8mkhJiDNcnDUJT5KKp-","data":[{"name":"stdout","output_type":"stream","text":"Note: you may need to restart the kernel to use updated packages.\n"}],"visibility":"show","key":"bO6EDvR8Z6"}],"visibility":"show","key":"JQvL3d6NIl"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from tqdm import tqdm\nimport time\nimport re\nfrom ratelimit import limits, sleep_and_retry\n\n# Set limit: max 4 calls per 1 seconds\nCALLS = 4\nPERIOD = 1  # seconds\n\n@sleep_and_retry\n@limits(calls=CALLS, period=PERIOD)\ndef call_api(url,auth_headers):\n    response = requests.get(url, headers=auth_headers, stream=True)\n    return response\n\n# we poll as long as the data is not ready\nif direct_download_url=='':\n    while url := response.headers.get(\"Location\"):\n        print(f\"order status: {response.json()['status']}\")\n        response = call_api(url,auth_headers)\n\nif (response.status_code not in (HTTP_SUCCESS_CODE,HTTP_ACCEPTED_CODE)):\n     (print(response.text))\n\n# Check if Content-Disposition header is present\nif \"Content-Disposition\" not in response.headers:\n    print(response)\n    print(response.text)\n    raise Exception(\"Headers: \\n\"+str(response.headers)+\"\\nContent-Disposition header not found in response. Must be something wrong.\")\n        \nfilename = re.findall('filename=\\\"?(.+)\\\"?', response.headers[\"Content-Disposition\"])[0]\ntotal_size = int(response.headers.get(\"content-length\", 0))\n\nprint(f\"downloading {filename}\")\n\nwith tqdm(total=total_size, unit=\"B\", unit_scale=True) as progress_bar:\n    with open(filename, 'wb') as f:\n        for data in response.iter_content(1024):\n            progress_bar.update(len(data))\n            f.write(data)","visibility":"show","key":"kAC8bmm774"},{"type":"output","id":"IZlwU61vchyVpNr-iUDLw","data":[{"name":"stdout","output_type":"stream","text":"order status: queued\ndownloading 0d68ccb8-6e25-409c-8e11-17e6f7823be0.grib\n"},{"name":"stderr","output_type":"stream","text":"100%|██████████| 26.2M/26.2M [00:00<00:00, 47.7MB/s]\n"}],"visibility":"show","key":"Bi8A1qZDIy"}],"visibility":"show","key":"kg9YoFD15W"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"EarthKit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bt9BkbJbPH"}],"identifier":"earthkit","label":"EarthKit","html_id":"earthkit","implicit":true,"key":"kxbGmsoakl"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Lets plot the result file\n[EarthKit Documentation] ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Wg4nhkhzx1"},{"type":"link","url":"https://earthkit-data.readthedocs.io/en/latest/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"https://​earthkit​-data​.readthedocs​.io​/en​/latest​/index​.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M0CwD1hnJR"}],"urlSource":"https://earthkit-data.readthedocs.io/en/latest/index.html","key":"p7bAEripsK"}],"key":"mRdJA6bPSO"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"This section requires that you have ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"BeRFfqjm20"},{"type":"inlineCode","value":"ecCodes >= 2.35","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"chhAXJFWzN"},{"type":"text","value":" installed on your system.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"hKnQJvyyVU"},{"type":"break","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Ofl6c4yisV"},{"type":"text","value":"You can follow the installation procedure at ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NzL8Bl34cm"},{"type":"link","url":"https://confluence.ecmwf.int/display/ECC/ecCodes+installation","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"https://​confluence​.ecmwf​.int​/display​/ECC​/ecCodes+installation","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"iOCK3jZfLO"}],"urlSource":"https://confluence.ecmwf.int/display/ECC/ecCodes+installation","key":"tuFegJWYHZ"}],"key":"HQ5ZHzhrlJ"}],"key":"znWSRwHpHe"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import earthkit.data\nimport earthkit.maps\nimport earthkit.regrid","visibility":"show","key":"Ub2eQvuGBY"},{"type":"output","id":"Qk1gR_P7agFdoHFVXyMDi","data":[],"visibility":"show","key":"m7rajWeP8V"}],"visibility":"show","key":"iztxJJAIJR"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"data = earthkit.data.from_source(\"file\", filename)\ndata.ls\nearthkit.maps.quickplot(data)\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")\nwarnings.simplefilter(action = \"ignore\", category = RuntimeWarning)","visibility":"show","key":"bhFa8ZBSBw"},{"type":"output","id":"0f3q-lOQdZQXqOUsYdg19","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"98bddafd9b4ad7eadd4bfc2342499770","path":"/build/98bddafd9b4ad7eadd4bfc2342499770.png"},"text/plain":{"content":"<Figure size 900x750 with 2 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"torZazRnyQ"}],"visibility":"show","key":"OdU47nUuO2"}],"key":"dytj99S5AI"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Destination Earth - Weather-Induced Extremes Digital Twin - Data Access using DEDL HDA","url":"/dedl-hda-eo-ecmwf-dat-dt-extremes","group":"HDA"},"next":{"title":"DEDL - HDA Extreme DT Parameter Plotter - Tutorial","url":"/extremedt-parameterplotter","group":"HDA"}}},"domain":"http://localhost:3001"}