{"version":2,"kind":"Notebook","sha256":"2476a71768710e01d06c6f4130f66d73b0bd24fa12fff309d1eacf8ce3757c40","slug":"dedl-hda-eo-ecmwf-dat-dt-climate","location":"/HDA/DestinE_Digital_Twins/DEDL-HDA-EO.ECMWF.DAT.DT_CLIMATE.ipynb","dependencies":[],"frontmatter":{"title":"Destination Earth - Climate Change Adaptation Digital Twin - Data Access using DEDL HDA","content_includes_title":true,"kernelspec":{"name":"python_dedl","display_name":"Python DEDL","language":"python"},"numbering":{"title":{"offset":2}},"thumbnail":"/build/b27bd30f978ddf0848f3ea0942070886.jpeg","exports":[{"format":"ipynb","filename":"DEDL-HDA-EO.ECMWF.DAT.DT_CLIMATE.ipynb","url":"/build/DEDL-HDA-EO.ECMWF.DA-a3241acf6bfaede112c461374d7c9b2a.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"image","url":"/build/b27bd30f978ddf0848f3ea0942070886.jpeg","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fZRHEW00Js","urlSource":"https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/img/DestinE-banner.jpg?raw=true"}],"visibility":"show","key":"NpMEgyYp2w"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Author","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AIpXCUtKuJ"}],"key":"gKPv3vMW1U"},{"type":"text","value":": EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hAKgnYRfsg"},{"type":"break","key":"xWl6iOr6KB"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"chckPPOOgt"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Copyright","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lIVBwiGBS9"}],"key":"c7hOnQNo7G"},{"type":"text","value":": 2024 EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C7G4M0iGjf"},{"type":"break","key":"cUl9s3F2HH"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wbMsAw60uv"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Licence","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E0TT3pzh94"}],"key":"qC6MBW3F7d"},{"type":"text","value":": MIT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CYnUboGtPS"},{"type":"break","key":"EvB3UWeiUk"}],"key":"YkiZfNGBki"},{"type":"heading","depth":1,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Destination Earth - Climate Change Adaptation Digital Twin - Data Access using DEDL HDA","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JyT6zsDCxD"}],"identifier":"destination-earth-climate-change-adaptation-digital-twin-data-access-using-dedl-hda","label":"Destination Earth - Climate Change Adaptation Digital Twin - Data Access using DEDL HDA","html_id":"destination-earth-climate-change-adaptation-digital-twin-data-access-using-dedl-hda","implicit":true,"key":"y0HgKCLnff"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"link","url":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-discovery-and-data-access/Introduction-to-Discovery-and-Data-Access-services/Introduction-to-Discovery-and-Data-Access-services.html#hda-harmonised-data-access","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Documentation DestinE Data Lake HDA","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"zEsMZ2tdhr"}],"urlSource":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-discovery-and-data-access/Introduction-to-Discovery-and-Data-Access-services/Introduction-to-Discovery-and-Data-Access-services.html#hda-harmonised-data-access","key":"WietQKwZv0"}],"key":"Fskl5pqY5M"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"link","url":"https://confluence.ecmwf.int/display/DDCZ/DestinE+Parameter+Portfolios","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Documentation Digital Twin - Parameter Usage","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ynzB9MKaBQ"}],"urlSource":"https://confluence.ecmwf.int/display/DDCZ/DestinE+Parameter+Portfolios","key":"mNKbd9kw9n"}],"key":"Qx37XyZMUD"}],"key":"woxWrifJBQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"break","key":"GMv1SCRwKI"},{"type":"text","value":"Author: EUMETSAT","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ehdrvCzTlG"}],"key":"au0ECZFMqk"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Credit: Earthkit and HDA Polytope used in this context are both packages provided by the European Centre for Medium-Range Weather Forecasts (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AG2ZiNoLfZ"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"ECMWF","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QpyeqylFtm"}],"key":"deLCX3mfkg"},{"type":"text","value":").","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MtE27pcHpQ"}],"key":"QAwdfsV4BW"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"DEDL Harmonised Data Access is used in this example.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EODxcXypgu"}],"key":"GWY5C4MGaL"}],"key":"YOSD9FMxXd"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Obtain Authentication Token","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qPDEnbOjs0"}],"identifier":"obtain-authentication-token","label":"Obtain Authentication Token","html_id":"obtain-authentication-token","implicit":true,"key":"VSJpfibzdT"}],"key":"p6Amot820j"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import requests\nfrom requests.adapters import HTTPAdapter\nfrom urllib3.util.retry import Retry\nimport json\nimport os\nfrom getpass import getpass\nimport destinelab as deauth\n\nimport importlib.metadata","visibility":"show","key":"fhqE0ovEYp"},{"type":"output","id":"cnYP4QcXDNLc7o3Y3agTV","data":[],"visibility":"show","key":"JZw1qG2FIw"}],"visibility":"show","key":"HtpSAhQv0g"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First, we get an access token for the API","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FVUpEBdiFK"}],"key":"uUyRvZ5IDE"}],"key":"eDbgfEhxQW"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"DESP_USERNAME = input(\"Please input your DESP username or email: \")\nDESP_PASSWORD = getpass(\"Please input your DESP password: \")\n\nauth = deauth.AuthHandler(DESP_USERNAME, DESP_PASSWORD)\naccess_token = auth.get_token()\nif access_token is not None:\n    print(\"DEDL/DESP Access Token Obtained Successfully\")\nelse:\n    print(\"Failed to Obtain DEDL/DESP Access Token\")\n\nauth_headers = {\"Authorization\": f\"Bearer {access_token}\"}","visibility":"show","key":"GDa7pfg0Bt"},{"type":"output","id":"s4CxGuEw2ghXEyE2qlSPj","data":[{"name":"stdin","output_type":"stream","text":"Please input your DESP username or email:  eum-dedl-user\nPlease input your DESP password:  ········\n"},{"name":"stdout","output_type":"stream","text":"Response code: 200\nDEDL/DESP Access Token Obtained Successfully\n"}],"visibility":"show","key":"I0cqkc0o0c"}],"visibility":"show","key":"F01swq4oiD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Check if DT access is granted","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pc3PzRucLz"}],"identifier":"check-if-dt-access-is-granted","label":"Check if DT access is granted","html_id":"check-if-dt-access-is-granted","implicit":true,"key":"k2fIkr8ZJl"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"If DT access is not granted, you will not be able to execute the rest of the notebook.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fB9wn0wSOU"}],"key":"h4sUmLMAXK"}],"key":"cNwTqtTYZV"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import importlib\ninstalled_version = importlib.metadata.version(\"destinelab\")\nversion_number = installed_version.split('.')[1]\nif((int(version_number) >= 8 and float(installed_version) < 1) or float(installed_version) >= 1):\n    auth.is_DTaccess_allowed(access_token)","visibility":"show","key":"ivBb5Qq7Qx"},{"type":"output","id":"57vWKEe70xBngegva5i2o","data":[{"name":"stdout","output_type":"stream","text":"DT Output access allowed\n"}],"visibility":"show","key":"Ds3imDqUcX"}],"visibility":"show","key":"RCWBwMgE6D"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Query using the DEDL HDA API","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TYCIwxDdot"}],"identifier":"query-using-the-dedl-hda-api","label":"Query using the DEDL HDA API","html_id":"query-using-the-dedl-hda-api","implicit":true,"key":"WeGC9Zhq8Q"}],"key":"qQBSYyOilI"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Filter","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YH07lkfr3a"}],"identifier":"filter","label":"Filter","html_id":"filter","implicit":true,"key":"VB9xOZkKzm"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We have to setup up a filter and define which data to obtain.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QLJOLx4HZs"}],"key":"AYqbJHBAqW"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Choose a valid combination of => ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"GvsyavDcWc"},{"type":"strong","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Activity + Experiment + Model","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"XyaIVeg2g5"}],"key":"ZA22bNtyD5"},{"type":"text","value":" (based on the year of interest)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"DRFA9ujyMH"}],"key":"TLk9D5MzUz"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Following ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"GpvFw9RRzk"},{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"activities/experiment/model","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"AqjzTrQxHa"}],"key":"W4whR1QXr2"},{"type":"text","value":" & dates are possible:","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"YD3ftn647W"}],"key":"F82sNn6PXJ"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"ScenarioMIP/ssp3-7.0/ICON: Start date 20200101, 40 years","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"vO0XLiFyDb"},{"type":"break","key":"ZlgtosyeIM"},{"type":"text","value":"\nScenarioMIP/ssp3-7.0/IFS-NEMO: Start date 20200101, 40 years","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"u6kWJnFjul"},{"type":"break","key":"n3bqGc9OAG"}],"key":"ogVfKDFLTm"}],"key":"Px3g3dMC15"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"datechoice = \"2028-06-10T00:00:00Z\"\nfilters = {\n    key: {\"eq\": value}\n    for key, value in {\n        \"class\": \"d1\",             # fixed \n        \"dataset\": \"climate-dt\",   # fixed climate-dt access\n        \"activity\": \"ScenarioMIP\", # activity + experiment + model (go together)\n        \"experiment\": \"SSP3-7.0\",  # activity + experiment + model (go together)\n        \"model\": \"IFS-NEMO\",       # activity + experiment + model (go together)\n        \"generation\": \"1\",         # fixed Specifies the generation of the dataset, which can be incremented as required (latest is 1)\n        \"realization\": \"1\",        # fixed Specifies the climate realization. Default 1. Based on perturbations of initial conditions\n        \"resolution\": \"high\",      # standard/ high \n        \"expver\": \"0001\",          # fixed experiment version \n        \"stream\": \"clte\",          # fixed climate\n        \"time\": \"0000\",            # choose the hourly slot(s)\n        \"type\": \"fc\",              # fixed forecasted fields\n        \"levtype\": \"sfc\",          # Surface fields (levtype=sfc), Height level fields (levtype=hl), Pressure level fields (levtype=pl), Model Level (Levtype=ml)\n#        \"levelist\": \"1/2/3/...\",  # for ml/pl/sol type data\n        \"param\": \"134\"             # Surface Pressure parameter\n    }.items()\n}","visibility":"show","key":"rNsYZbKVYy"},{"type":"output","id":"6ETV5PwMUVOudvk647uNv","data":[],"visibility":"show","key":"GI8niU3IBn"}],"visibility":"show","key":"ULKINjbR3B"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make Data Request","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YWWVe4qKR4"}],"identifier":"make-data-request","label":"Make Data Request","html_id":"make-data-request","implicit":true,"key":"ND6YRqvuIS"}],"visibility":"show","key":"GaBMd1dcKN"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"#Sometimes requests to polytope get timeouts, it is then convenient define a retry strategy\nretry_strategy = Retry(\n    total=5,  # Total number of retries\n    status_forcelist=[500, 502, 503, 504],  # List of 5xx status codes to retry on\n    allowed_methods=[\"GET\",'POST'],  # Methods to retry\n    backoff_factor=1  # Wait time between retries (exponential backoff)\n)\n\n# Create an adapter with the retry strategy\nadapter = HTTPAdapter(max_retries=retry_strategy)\n\n# Create a session and mount the adapter\nsession = requests.Session()\nsession.mount(\"https://\", adapter)\n\nresponse = session.post(\"https://hda.data.destination-earth.eu/stac/search\", headers=auth_headers, json={\n \"collections\": [\"EO.ECMWF.DAT.DT_CLIMATE_ADAPTATION\"],\n    \"datetime\": datechoice,\n    \"query\": filters\n})\n\nif(response.status_code!= 200):\n    (print(response.text))\nresponse.raise_for_status()\n\n# Requests to EO.ECMWF.DAT.DT_CLIMATE always return a single item containing all the requested data\nproduct = response.json()[\"features\"][0]\nproduct[\"id\"]","visibility":"show","key":"m6Yzj7V40L"},{"type":"output","id":"T9k_hceEvI1jgRf4hGbfE","data":[{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/plain":{"content":"'DT_CLIMATE_ADAPTATION_20280610_20280610_d17e8acc7cca7293dd5b720591a7c975be30a931'","content_type":"text/plain"}}}],"visibility":"show","key":"dckJSn2stk"}],"visibility":"show","key":"HgysdJXwf5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Submission worked ? Once our product found, we download the data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ocT16jtJI0"}],"identifier":"submission-worked-once-our-product-found-we-download-the-data","label":"Submission worked ? Once our product found, we download the data.","html_id":"submission-worked-once-our-product-found-we-download-the-data","implicit":true,"key":"CV321suFYl"}],"key":"ZS4TIqdBI2"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import JSON\n\n# DownloadLink is an asset representing the whole product\ndownload_url = product[\"assets\"][\"downloadLink\"][\"href\"]\nHTTP_SUCCESS_CODE = 200\nHTTP_ACCEPTED_CODE = 202\n\ndirect_download_url=''\n\nresponse = session.get(download_url, headers=auth_headers)\nif (response.status_code == HTTP_SUCCESS_CODE):\n    direct_download_url = product['assets']['downloadLink']['href']\nelif (response.status_code != HTTP_ACCEPTED_CODE):\n    print(response.text)\nprint(download_url)\nresponse.raise_for_status()    ","visibility":"show","key":"uoXBaxfuTx"},{"type":"output","id":"zcJz4FjJXNCWqkfAMuNzs","data":[{"name":"stdout","output_type":"stream","text":"https://hda.data.destination-earth.eu/stac/collections/EO.ECMWF.DAT.DT_CLIMATE_ADAPTATION/items/DT_CLIMATE_ADAPTATION_20280610_20280610_d17e8acc7cca7293dd5b720591a7c975be30a931/download?provider=dedt_lumi&_dc_qs=%257B%2522activity%2522%253A%2B%2522ScenarioMIP%2522%252C%2B%2522class%2522%253A%2B%2522d1%2522%252C%2B%2522dataset%2522%253A%2B%2522climate-dt%2522%252C%2B%2522date%2522%253A%2B%252220280610%252Fto%252F20280610%2522%252C%2B%2522experiment%2522%253A%2B%2522SSP3-7.0%2522%252C%2B%2522expver%2522%253A%2B%25220001%2522%252C%2B%2522generation%2522%253A%2B%25221%2522%252C%2B%2522levtype%2522%253A%2B%2522sfc%2522%252C%2B%2522model%2522%253A%2B%2522IFS-NEMO%2522%252C%2B%2522param%2522%253A%2B%2522134%2522%252C%2B%2522realization%2522%253A%2B%25221%2522%252C%2B%2522resolution%2522%253A%2B%2522high%2522%252C%2B%2522stream%2522%253A%2B%2522clte%2522%252C%2B%2522time%2522%253A%2B%25220000%2522%252C%2B%2522type%2522%253A%2B%2522fc%2522%257D\n"}],"visibility":"show","key":"dIkrQ3QBbR"}],"visibility":"show","key":"VyEkSeABeU"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Wait until data is there","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bc6hhgxd25"}],"identifier":"wait-until-data-is-there","label":"Wait until data is there","html_id":"wait-until-data-is-there","implicit":true,"key":"zzcCStcQ6N"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This data is not available at the moment. And we can see that our request is in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dSroLa1CT4"},{"type":"inlineCode","value":"queued","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"D96QTbZWYp"},{"type":"text","value":"status.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"G3yZAxolcP"},{"type":"break","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"esgWEf8k58"},{"type":"text","value":"We will now poll the API until the data is ready and then download it.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ei2XDqzbyX"}],"key":"SlPfx95HD2"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Please note that the basic HDA quota allows a maximum of 4 requests per second. The following code limits polling to this quota.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NAIXT6KqGG"}],"key":"nHYPjYwxR7"}],"key":"EUUxOcX3a9"}],"key":"pLJK4BT5Gp"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"pip install ratelimit --quiet","visibility":"show","key":"w6WVCF71dJ"},{"type":"output","id":"IBgnVZEJK9vvzDVygNHy_","data":[{"name":"stdout","output_type":"stream","text":"Note: you may need to restart the kernel to use updated packages.\n"}],"visibility":"show","key":"m5Yp7DsuUz"}],"visibility":"show","key":"J0jNMzARIJ"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"from tqdm import tqdm\nimport time\nimport re\nfrom ratelimit import limits, sleep_and_retry\n\n# Set limit: max 4 calls per 1 seconds\nCALLS = 4\nPERIOD = 1  # seconds\n\n@sleep_and_retry\n@limits(calls=CALLS, period=PERIOD)\ndef call_api(url,auth_headers):\n    response = session.get(url, headers=auth_headers, stream=True)\n    return response\n\n# we poll as long as the data is not ready\nif direct_download_url=='':\n    while url := response.headers.get(\"Location\"):\n        print(f\"order status: {response.json()['status']}\")\n        response = call_api(url,auth_headers)  \n        \nif (response.status_code not in (HTTP_SUCCESS_CODE,HTTP_ACCEPTED_CODE)):\n     (print(response.text))\n\n# Check if Content-Disposition header is present\nif \"Content-Disposition\" not in response.headers:\n    print(response)\n    print(response.text)\n    raise Exception(\"Headers: \\n\"+str(response.headers)+\"\\nContent-Disposition header not found in response. Must be something wrong.\")\n        \nfilename = re.findall('filename=\\\"?(.+)\\\"?', response.headers[\"Content-Disposition\"])[0]\ntotal_size = int(response.headers.get(\"content-length\", 0))\n\nprint(f\"downloading {filename}\")\n\nwith tqdm(total=total_size, unit=\"B\", unit_scale=True) as progress_bar:\n    with open(filename, 'wb') as f:\n        for data in response.iter_content(1024):\n            progress_bar.update(len(data))\n            f.write(data)","visibility":"show","key":"BoEO33ckgw"},{"type":"output","id":"aYXHHkLRl-LdZh8IDDGcd","data":[{"name":"stdout","output_type":"stream","text":"order status: queued\ndownloading 9a60b3de-6e37-4e6c-88cf-c0eb2dfd7714.grib\n"},{"name":"stderr","output_type":"stream","text":"100%|██████████| 23.6M/23.6M [00:00<00:00, 52.7MB/s]\n"}],"visibility":"show","key":"AgjWjr9Qe3"}],"visibility":"show","key":"XFcNT5RKG6"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"EarthKit","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cSlvFh1szb"}],"identifier":"earthkit","label":"EarthKit","html_id":"earthkit","implicit":true,"key":"zwRLxelnKs"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Lets plot the result file\n[EarthKit Documentation] ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CdZIiRTMJ1"},{"type":"link","url":"https://earthkit-data.readthedocs.io/en/latest/index.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"https://​earthkit​-data​.readthedocs​.io​/en​/latest​/index​.html","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ubfwY2Uwp7"}],"urlSource":"https://earthkit-data.readthedocs.io/en/latest/index.html","key":"oEVSPqWlKM"}],"key":"jY5g3NRk8r"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"This section requires that you have ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"QDl6TNHlR8"},{"type":"inlineCode","value":"ecCodes >= 2.35","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ns4nWKDlAZ"},{"type":"text","value":" installed on your system.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"J90fXR0Cq4"},{"type":"break","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"sPk8R7SxXG"},{"type":"text","value":"You can follow the installation procedure at ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"qbKevS8KjR"},{"type":"link","url":"https://confluence.ecmwf.int/display/ECC/ecCodes+installation","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"https://​confluence​.ecmwf​.int​/display​/ECC​/ecCodes+installation","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XiNwr2VPCj"}],"urlSource":"https://confluence.ecmwf.int/display/ECC/ecCodes+installation","key":"C1icHae4Ap"}],"key":"k6LjCfuYDg"}],"key":"qZ5TCOLpn1"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import earthkit.data\nimport earthkit.maps\nimport earthkit.regrid","visibility":"show","key":"lOqD7Cs9Sv"},{"type":"output","id":"OV0wGpLnK5Yuq8TrVFrKJ","data":[],"visibility":"show","key":"YJwHkTjjnA"}],"visibility":"show","key":"KsbJfHoYQy"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"data = earthkit.data.from_source(\"file\", filename)\ndata.ls\nearthkit.maps.quickplot(data,#style=style\n                       )","visibility":"show","key":"HYFfFNdYvp"},{"type":"output","id":"fCUyiRhlKWBLbEKvNvTEL","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"06480ef82b2ea5d9d017077b27aab6f9","path":"/build/06480ef82b2ea5d9d017077b27aab6f9.png"},"text/plain":{"content":"<Figure size 900x750 with 2 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"BTEKnnJ0s9"}],"visibility":"show","key":"jCSOvQhGBn"}],"key":"hIyPBts5VJ"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Destination Earth - Weather-Induced Extremes Digital Twin - Data Access using DEDL HDA","url":"/dedl-hda-eo-ecmwf-dat-dt-extremes-series","group":"HDA"},"next":{"title":"Destination Earth - ERA5 hourly data on single levels from 1940 to present - Data Access using DEDL HDA","url":"/dedl-hda-eo-ecmwf-dat-reanalysis-era5-single-level","group":"HDA"}}},"domain":"http://localhost:3001"}